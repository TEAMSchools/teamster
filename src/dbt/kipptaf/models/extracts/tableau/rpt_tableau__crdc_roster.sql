-- enter the student numbers below for DSED-2
{% set distance_ed_student_numbers = [
    203471,
    200003,
    202172,
    17797,
    19225,
    17557,
    200676,
    202218,
    18038,
    17854,
    17683,
    17919,
    202294,
    18384,
    201202,
    17504,
    200897,
    203533,
    11625,
    17279,
    104006,
    11467,
    14556,
    102526,
    12357,
    103554,
    19107,
    102132,
    17332,
    100132,
    17208,
    17398,
    103788,
    101084,
    104483,
] %}

-- enter the student numbers below for PENR-4a
{% set dual_enroll_student_numbers = [
    17964,
    17491,
    17492,
    200584,
    19400,
    17255,
    17773,
    15196,
    17802,
    19232,
    17557,
    18471,
    17821,
    19770,
    17855,
    202598,
    17601,
    18250,
    19289,
    19301,
    18122,
    17636,
    17639,
    17646,
    17650,
    201622,
    201625,
    19515,
    17661,
    201631,
    201635,
    17908,
    202632,
    17708,
    202705,
    17462,
    202218,
    17727,
    200241,
    17279,
    11445,
    102363,
    103960,
    103977,
    17293,
    17361,
    14149,
    102141,
    18066,
    18042,
    13979,
    11489,
    103554,
    102361,
    103976,
    13674,
    17254,
    102539,
    11818,
    103538,
    102516,
    11447,
    103609,
    17356,
    17325,
    102326,
    17332,
    101197,
    103553,
    103561,
    14289,
    14556,
    101998,
    102450,
    19107,
    102132,
    11476,
    17285,
    14413,
    17263,
    102002,
    17861,
    14396,
    17312,
    103004,
    10483,
    103995,
    12357,
    14077,
    20030,
    102512,
    101996,
    11098,
    102435,
    103543,
    11442,
    17335,
    17208,
    19609,
    102527,
    17286,
    104047,
    17290,
    11410,
    102441,
    11397,
    101160,
    102466,
    17288,
    101982,
    17429,
    12334,
    17352,
    18275,
    11468,
    101226,
    14236,
    101449,
    17858,
    102549,
    17357,
    11395,
    14416,
    101987,
    16093,
    17448,
    17400,
    17265,
    11454,
    103444,
    17399,
    102348,
    11403,
    13236,
    105636,
    17347,
    11396,
    17977,
    11483,
    14450,
    18090,
    17309,
] %}

-- enter the student numbers below for PENR-6
{% set credit_recovery_student_numbers = [
    17477,
    200120,
    203982,
    17746,
    13934,
    19059,
    201212,
    17647,
    17803,
    17504,
    203825,
    204001,
    200363,
    203768,
    17570,
    200617,
    19303,
    200690,
    203912,
    204009,
    19572,
    19573,
    204037,
    17581,
    200875,
    200936,
    17735,
    200618,
    203962,
    17494,
    200615,
    19181,
    200124,
    200897,
    201053,
    203829,
    203847,
    105637,
    106877,
    105481,
    18330,
    107643,
    11866,
    105403,
    107339,
    12261,
    107737,
    104563,
    105643,
    107665,
    104581,
    11922,
    102694,
    11930,
    106863,
    103771,
    107315,
    102147,
    12455,
    107326,
    102127,
    102667,
    104538,
    14277,
    11917,
    106944,
    107573,
    104545,
    103887,
    107334,
    12383,
    107670,
    102652,
    106347,
    105405,
    106502,
    103017,
    107724,
    11856,
    18767,
    103013,
    18671,
    105504,
    107755,
    12208,
    101316,
    104432,
    12401,
    105618,
    12340,
    107467,
    104490,
    107388,
    107642,
    12492,
    13637,
    105800,
    12545,
    13347,
    17193,
    107258,
    13701,
    105181,
    106957,
    105990,
    18509,
    105723,
    100324,
    12560,
    17229,
    107666,
    13668,
    103848,
    107725,
    13453,
    105969,
    107230,
    107211,
    106255,
    14002,
] %}

-- enter the student numbers below for ATHL-3
{% set athletics_student_numbers = [
    17964,
    17746,
    19770,
    19396,
    19400,
    202705,
    17773,
    18690,
    15196,
    17534,
    17802,
    17817,
    17569,
    19254,
    19256,
    19260,
    19008,
    19010,
    202654,
    19269,
    17855,
    17606,
    200241,
    17639,
    17648,
    200708,
    17657,
    203708,
    19515,
    17661,
    200582,
    200584,
    17668,
    18055,
    19371,
    18079,
    201622,
    201624,
    17708,
    17462,
    201636,
    17721,
    18384,
    17725,
    17727,
    202240,
    202312,
    17748,
    202638,
    19411,
    201166,
    19206,
    19422,
    17790,
    19573,
    17540,
    19223,
    202550,
    19588,
    19462,
    200679,
    19246,
    201186,
    17842,
    200550,
    17596,
    200178,
    201103,
    19059,
    202473,
    17647,
    19351,
    202667,
    18062,
    202618,
    202495,
    18609,
    201616,
    18087,
    200605,
    17468,
    201848,
    200818,
    17495,
    17499,
    203771,
    200830,
    200853,
    17800,
    201210,
    200943,
    200115,
    200124,
    200127,
    200148,
    200158,
    19284,
    200199,
    200330,
    200361,
    19362,
    200759,
    201615,
    203743,
    202502,
    203472,
    201855,
    203167,
    15172,
    17764,
    201094,
    202368,
    200882,
    15557,
    202389,
    203656,
    15641,
    203669,
    200521,
    202404,
    202405,
    200528,
    200536,
    203019,
    200999,
    203341,
    201114,
    13872,
    13894,
    13902,
    14279,
    19710,
    13923,
    200791,
    201087,
    17290,
    102003,
    18222,
    101996,
    102539,
    102516,
    17356,
    11467,
    11411,
    14134,
    17918,
    20030,
    11447,
    17254,
    10475,
    11445,
    14289,
    104098,
    17859,
    102142,
    17398,
    20383,
    11818,
    102141,
    105694,
    102515,
    17374,
    101179,
    11476,
    11625,
    14129,
    103565,
    105964,
    100211,
    14413,
    102511,
    103977,
    17208,
    101160,
    18042,
    17335,
    17282,
    11420,
    11490,
    12334,
    101211,
    14450,
    101982,
    101449,
    11483,
    11482,
    13236,
    11457,
    17294,
    103444,
    102535,
    14057,
    14419,
    13694,
    17314,
    17281,
    11403,
    102137,
    17306,
    20026,
    14236,
    102549,
    20157,
    101070,
    102635,
    107596,
    17283,
    103472,
    18136,
    107591,
    19637,
    16786,
    105956,
    107540,
    12257,
    107597,
    103462,
    103012,
    17226,
    12180,
    104221,
    107563,
    105405,
    101455,
    12173,
    100152,
    14283,
    103016,
    103746,
    103007,
    100621,
    12169,
    11907,
    101396,
    107402,
    103011,
    17218,
    11866,
    103929,
    18593,
    103482,
    11893,
    14841,
    12222,
    105659,
    12340,
    13955,
    105943,
    102508,
    102667,
    107543,
    18648,
    12255,
    12205,
    103996,
    12364,
    103460,
    18246,
    12250,
    103476,
    12188,
    105714,
    12176,
    11868,
    105597,
    19437,
    104224,
    11884,
    104296,
    107574,
    100357,
    107433,
    105271,
    11888,
    105820,
    104288,
    105746,
    11862,
    18602,
    19454,
    12252,
    19482,
    12373,
    17240,
    19145,
    18643,
    12297,
    20468,
    103787,
    105178,
    101393,
    19436,
    12230,
    103494,
    17222,
    107550,
    104302,
    17231,
    107607,
    105599,
    19615,
    104461,
    12664,
    18934,
    107112,
    100620,
    105922,
    105787,
    105977,
    17203,
    104458,
    104182,
    104478,
    104388,
    11871,
    12472,
    17198,
    104469,
    17192,
    13115,
    105703,
    104201,
    16679,
    102567,
    105951,
    105573,
    12566,
    104405,
    105782,
    105957,
    105949,
    105632,
    16718,
    107204,
    18536,
    12475,
    12564,
    12438,
    105837,
    106933,
    12388,
    104438,
    12501,
    104574,
    106333,
    105693,
    14177,
    12504,
    105953,
    12614,
    104516,
    107260,
    104464,
    12166,
    12631,
    105768,
    19499,
    105788,
    100591,
    18814,
    12492,
    16076,
    13103,
    107354,
    104292,
    105924,
    103389,
    17221,
    12422,
    107031,
    15404,
    18617,
    12996,
    107008,
    12648,
    12638,
    12665,
    105616,
    105266,
    102192,
    18724,
    102661,
    107496,
    12610,
    101150,
    104289,
    104299,
    12632,
    13628,
    13371,
    102144,
    101030,
    106925,
    101208,
    13526,
    104322,
    13349,
    107090,
    106863,
    19167,
    14699,
    13508,
    13626,
    13537,
    13450,
    106961,
    100223,
    13535,
    13559,
    13651,
    104093,
    104039,
    19987,
    103860,
    100253,
    102166,
    18721,
    13680,
    101512,
    13696,
    19523,
    101406,
    102125,
    105732,
    13617,
    100999,
    13639,
    106501,
    14154,
    102311,
    13490,
    13436,
    105978,
    13986,
    101174,
    17958,
    13999,
    107157,
    105989,
    100918,
    103595,
    106885,
    19727,
    19583,
    13403,
    105971,
    107372,
    106912,
    107445,
    13468,
    107104,
    14025,
    14092,
    15901,
    14158,
    107400,
    104264,
    14180,
    20488,
    106831,
    14174,
] %}

-- enter the student numbers on the first array, and their matching crdc question
-- group on the second array. order is important for the loop to work properly in the
-- allocated cte
{% set arrests_student_numbers = [201150, 105805, 106658, 106658, 201150, 105805] %}
{% set arrests_crdc_question_section = [
    "ARRS-1",
    "ARRS-1",
    "ARRS-1",
    "ARRS-2",
    "ARRS-3",
    "ARRS-3",
] %}

with
    manual_check as (
        -- distance ed students
        select cast(student as numeric) as student_number, crdc_question_section,
        from
            (
                {% for i in range(distance_ed_student_numbers | length) %}
                    select
                        '{{ distance_ed_student_numbers[i] }}' as student,
                        'DSED-2' as crdc_question_section
                    {% if not loop.last %}
                        union all
                    {% endif %}
                {% endfor %}
            ) as matched_data

        union all

        -- dual enroll students
        select cast(student as numeric) as student_number, crdc_question_section,
        from
            (
                {% for i in range(dual_enroll_student_numbers | length) %}
                    select
                        '{{ dual_enroll_student_numbers[i] }}' as student,
                        'PENR-4a' as crdc_question_section
                    {% if not loop.last %}
                        union all
                    {% endif %}
                {% endfor %}
            ) as matched_data

        union all

        -- credit recovery students
        select cast(student as numeric) as student_number, crdc_question_section,
        from
            (
                {% for i in range(credit_recovery_student_numbers | length) %}
                    select
                        '{{ credit_recovery_student_numbers[i] }}' as student,
                        'PENR-6' as crdc_question_section
                    {% if not loop.last %}
                        union all
                    {% endif %}
                {% endfor %}
            ) as matched_data

        union all

        -- athletics
        select cast(student as numeric) as student_number, crdc_question_section,
        from
            (
                {% for i in range(athletics_student_numbers | length) %}
                    select
                        '{{ athletics_student_numbers[i] }}' as student,
                        'ATHL-3' as crdc_question_section
                    {% if not loop.last %}
                        union all
                    {% endif %}
                {% endfor %}
            ) as matched_data

        union all

        -- arrests
        select cast(student as numeric) as student_number, crdc_question_section,
        from
            (
                {% for i in range(arrests_student_numbers | length) %}
                    select
                        '{{ arrests_student_numbers[i] }}' as student,
                        '{{ arrests_crdc_question_section[i] }}'
                        as crdc_question_section
                    {% if not loop.last %}
                        union all
                    {% endif %}
                {% endfor %}
            ) as matched_data
    ),

    retained as (
        -- reason for distinct: for students with multiple enrollments
        select distinct student_number, is_retained_year,
        from {{ ref("base_powerschool__student_enrollments") }}
        where
            -- submission is always for the previous school year, but retention is
            -- tracked only on the submission year + 1 (current academic year)
            academic_year = {{ var("current_academic_year") }}
            and grade_level != 99
            and is_retained_year
            -- miami does their own submission
            and region != 'Miami'
    ),

    -- because of the manual check cte, this cte will have dups, but they will be
    -- addressed in the main select statement when the question group counts are
    -- calculated
    enrollment as (
        select
            e._dbt_source_relation,
            e.academic_year,
            e.region,
            e.schoolid,
            e.school_abbreviation,

            e.studentid,
            e.student_number,
            e.grade_level,
            e.entrydate,
            e.exitdate,
            e.enroll_status,

            e.rn_year,
            e.is_enrolled_oct01,

            e.gender,
            e.ethnicity,
            e.gifted_and_talented,
            e.is_504,
            e.lep_status,

            adb.contact_id,

            -- tag the manual entry checks to their crdc question
            mc.crdc_question_section as crdc_question_section_manual_check,

            coalesce(r.is_retained_year, false) as is_retained_year,

            case
                e.gender
                when 'F'
                then 'Female'
                when 'M'
                then 'Male'
                when 'X'
                then 'Nonbinary'
            end as crdc_gender,

            case
                e.ethnicity
                when 'H'
                then 'Hispanic or Latino of any race'
                when 'I'
                then 'American Indian or Alaska Native'
                when 'A'
                then 'Asian'
                when 'P'
                then 'Native Hawaiian or Other Pacific Islander'
                when 'B'
                then 'Black or African American'
                when 'W'
                then 'White'
                when 'T'
                then 'Two or more races'
            end as crdc_demographic,

            -- bring over the manual entry student numbers that match the crdc
            -- question tag
            if(mc.student_number is null, false, true) as student_manual_check,

            if(
                e.exitdate = date(e.academic_year + 1, 06, 30), true, false
            ) as is_last_day_enrolled,

            if(e.spedlep like 'SPED%', 'Has IEP', 'No IEP') as iep_status,

            if(e.spedlep like 'SPED%' and not is_504, true, false) as iep_only,

            if(e.spedlep like 'SPED%' and is_504, true, false) as iep_and_c504,

            if(e.spedlep not like 'SPED%' and is_504, true, false) as c504_only,

        from {{ ref("base_powerschool__student_enrollments") }} as e
        left join
            {{ ref("int_kippadb__roster") }} as adb
            on e.student_number = adb.student_number
        left join retained as r on e.student_number = r.student_number
        left join manual_check as mc on e.student_number = mc.student_number
        where
            -- submission is always for the previous school year
            e.academic_year = {{ var("current_academic_year") - 1 }}
            and e.grade_level != 99
            -- miami does their own submission
            and e.region != 'Miami'
    ),

    custom_schedule as (
        select
            c._dbt_source_relation,
            c.cc_academic_year,
            c.cc_schoolid,

            c.cc_studentid,
            c.students_student_number,
            c.cc_dateenrolled,
            c.cc_dateleft,

            c.courses_course_number,
            c.courses_course_name,
            c.sections_dcid,
            c.sections_id,
            c.sections_external_expression,

            c.is_dropped_course,
            c.is_dropped_section,

            c.ap_course_subject,
            c.is_ap_course,
            c.courses_isfitnesscourse,

            c.rn_credittype_year,
            c.rn_course_number_year,

            c.terms_lastday,

            x.sced_course_name,
            x.crdc_course_group,
            x.crdc_subject_group,
            x.crdc_ap_group,
            x.sced_code as sced_code_xwalk,

            g.grade,
            g.is_transfer_grade,

            coalesce(x.ap_tag, false) as ap_tag,

            concat(c.nces_subject_area, c.nces_course_id) as sced_code_courses,

            if(
                c.is_ap_course != coalesce(x.ap_tag, false), true, false
            ) as ap_tag_mismatch,

            if(grade like 'F%', false, true) as passed_course,

            if(
                c.courses_course_name like '%(DE)' and not c.is_ap_course, true, false
            ) as is_dual_enrollment,

            if(
                c.courses_course_name like '%(CR)'
                -- any other school would be a credit recovery course taken
                -- outside of KTAF
                and g.schoolname = 'KIPP Summer School',
                true,
                false
            ) as is_credit_recovery,

            -- some data is needed as of fall snapshot
            if(
                c.cc_dateenrolled <= '2023-10-02' and c.cc_dateleft >= '2023-10-02',
                true,
                false
            ) as is_oct_01_course,

            -- some data is needed as of the last day of school
            if(c.cc_dateleft >= c.terms_lastday, true, false) as is_last_day_course,

        from {{ ref("base_powerschool__course_enrollments") }} as c
        left join
            {{ ref("stg_powerschool__storedgrades") }} as g
            on c.cc_academic_year = g.academic_year
            and c.sections_id = g.sectionid
            and c.cc_studentid = g.studentid
            and {{ union_dataset_join_clause(left_alias="c", right_alias="g") }}
            and g.storecode = 'Y1'
        left join
            {{ ref("stg_crdc__sced_code_crosswalk") }} as x
            on concat(c.nces_subject_area, c.nces_course_id) = x.sced_code
        -- submission is always for the previous school year
        where
            c.cc_academic_year = {{ var("current_academic_year") - 1 }}
            -- miami does their own submission
            and regexp_extract(c._dbt_source_relation, r'(kipp\w+)_') != 'kippmiami'

    ),

    -- this CTE is appending the different versions/groupings i need for reporting
    -- on course data dual enrolled students
    final_schedule as (
        select *, 'PENR-4' as crdc_question_section,
        from custom_schedule
        where is_dual_enrollment and is_oct_01_course

        union all

        -- credit recovery students
        select *, 'PENR-6' as crdc_question_section,
        from custom_schedule
        where is_credit_recovery

        union all

        -- algebra classes for MS; we don't do geometry, so there will be no cte
        -- for it
        -- for it
        select *, 'COUR-1' as crdc_question_section,
        from custom_schedule
        -- alg 1 ms courses use a special code
        where sced_code_courses = '52052'

        union all

        -- hs math courses
        select *, 'COUR-7' as crdc_question_section,
        from custom_schedule
        where
            crdc_subject_group in (
                'Algebra I',
                'Geometry',
                'Algebra II',
                'Advanced Mathematics',
                'Calculus',
                'Algebra I / Algebra II'
            )

        union all

        -- hs science courses
        select
            *,
            case
                crdc_subject_group
                when 'Computer Science'
                then 'COUR-18'
                when 'Data Science'
                then 'COUR-20'
                else 'COUR-14'
            end as crdc_question_section,

        from custom_schedule
        where
            crdc_subject_group
            in ('Biology', 'Chemistry', 'Physics', 'Computer Science', 'Data Science')
            and is_oct_01_course

        union all

        -- ap courses that have correct tags on PS
        select *, 'APIB-4' as crdc_question_section,
        from custom_schedule
        -- crdc ap group is needed to not count the AP courses crdc doesnt like
        where ap_tag_mismatch and crdc_ap_group is not null and is_oct_01_course

        union all

        -- ap courses that have incorrect tags on PS
        select *, 'APIB-4' as crdc_question_section,
        from custom_schedule
        -- crdc ap group is needed to not count the AP courses crdc doesnt like
        where
            not ap_tag_mismatch
            and is_ap_course
            and crdc_ap_group is not null
            and is_oct_01_course
    ),

    act_sat as (
        -- this count(*) serves no purpose other than avoiding a distinct lol
        select contact, count(*) as attempts
        from {{ ref("int_kippadb__standardized_test_unpivot") }}
        where
            score_type in ('act_composite', 'sat_total_score')
            and `date` between '2023-08-15' and '2024-06-13'
        group by all
    ),

    -- tracks discipline, ISS/OSS and restraints
    discipline_rollup as (
        select
            dli.student_school_id as student_number,
            dli.create_ts_academic_year as academic_year,

            case
                when
                    count(
                        distinct case
                            when cf.restraint_used = 'Y' then dli.incident_id else null
                        end
                    )
                    > 0
                then 1
                else 0
            end as is_restraint_int,

            count(
                distinct case
                    when cf.restraint_used = 'Y' then dli.incident_id else null
                end
            ) as n_restraint_incidents,

            case
                when
                    count(
                        distinct case
                            when dlp.penalty_name like '%Out-of-School Suspension'
                            then dlp.incident_penalty_id
                        end
                    )
                    = 1
                then 1
                else 0
            end as is_oss_one_int,

            case
                when
                    count(
                        distinct case
                            when dlp.penalty_name like '%Out-of-School Suspension'
                            then dlp.incident_penalty_id
                        end
                    )
                    > 1
                then 1
                else 0
            end as is_oss_two_plus_int,

            max(
                case
                    when dlp.penalty_name like '%In-School Suspension' then 1 else 0
                end
            ) as is_iss_int,

            sum(
                case
                    when dlp.penalty_name like '%Out-of-School Suspension'
                    then dlp.num_days
                    else null
                end
            ) as oss_days_missed,

            count(
                distinct case
                    when dlp.penalty_name like '%Out-of-School Suspension'
                    then dlp.incident_penalty_id
                end
            ) as oss_incident_count,

        from {{ ref("stg_deanslist__incidents") }} as dli
        left join
            {{ ref("stg_deanslist__incidents__penalties") }} as dlp
            on dli.incident_id = dlp.incident_id
            and {{ union_dataset_join_clause(left_alias="dli", right_alias="dlp") }}
        left join
            {{ ref("int_deanslist__incidents__custom_fields__pivot") }} as cf
            on dli.incident_id = cf.incident_id
            and {{ union_dataset_join_clause(left_alias="dli", right_alias="cf") }}
        where dli.is_active
        group by dli.student_school_id, dli.create_ts_academic_year
    )

-- ENRL-3, by ethnicity/gender. dups may be present because of students changing
-- schools or grade level midyear
select
    _dbt_source_relation,
    academic_year,
    region,
    schoolid,
    school_abbreviation,

    studentid,
    student_number,
    contact_id,
    grade_level,
    gender,
    ethnicity,
    gifted_and_talented,
    iep_status,
    is_504,
    iep_only,
    iep_and_c504,
    c504_only,
    lep_status,

    entrydate,
    exitdate,
    enroll_status,
    is_enrolled_oct01,
    is_last_day_enrolled,
    is_retained_year,
    rn_year,

    crdc_demographic,
    crdc_gender,

    'ENRL-1' as crdc_question_section,
    'Student Enrollment' as crdc_question_description,

from enrollment
where is_enrolled_oct01
