with
    form_responses as (
        select
            response_id,
            respondent_email,
            last_submitted_time,
            rn_form_respondent_submitted_desc,
            rn_form_item_respondent_submitted_desc,
            item_abbreviation,
            coalesce(text_value, file_upload_file_id) as pivot_column_value,
        from {{ ref("base_google_forms__form_responses") }}
        where
            form_id = '1jpeMof_oQ9NzTw85VFsA5A7G9VrH3XkSc_nZDFz07nA'
            and rn_form_respondent_submitted_desc = 1
    ),

    response_pivot as (
        select
            response_id,
            respondent_email,
            last_submitted_time,
            rn_form_respondent_submitted_desc,
            rn_form_item_respondent_submitted_desc,

            {# pivot cols #}
            `additional_languages`,
            `cert_barriers`,
            `cert_out_of_state_details`,
            `cert_required`,
            `cert_status`,
            `cert_steps_taken`,
            `fl_additional_cert_1`,
            `fl_cert_endorsement_1`,
            `fl_cert_endorsement_2`,
            `fl_cert_endorsement_3`,
            `fl_cert_endorsement_4`,
            `fl_cert_endorsement_5`,
            `fl_cert_expiration_1`,
            `fl_cert_expiration_2`,
            `fl_cert_expiration_3`,
            `fl_cert_expiration_4`,
            `fl_cert_expiration_5`,
            `fl_open_to_student_teacher`,
            `gender_identity`,
            `languages_spoken`,
            `level_of_education`,
            `nj_cert_additional_1`,
            `nj_cert_document_link_1`,
            `nj_cert_document_link_2`,
            `nj_cert_document_link_3`,
            `nj_cert_document_link_4`,
            `nj_cert_document_link_5`,
            `nj_cert_endorsement_1`,
            `nj_cert_endorsement_2`,
            `nj_cert_endorsement_3`,
            `nj_cert_endorsement_4`,
            `nj_cert_endorsement_5`,
            `nj_cert_issue_date_1`,
            `nj_cert_issue_date_2`,
            `nj_cert_issue_date_3`,
            `nj_cert_issue_date_4`,
            `nj_cert_issue_date_5`,
            `nj_cert_type_1`,
            `nj_cert_type_2`,
            `nj_cert_type_3`,
            `nj_cert_type_4`,
            `nj_cert_type_5`,
            `race_ethnicity`,
            `respondent_name`,
            `undergraduate_school`,
            cast(`years_teaching_in_njfl` as int) as years_teaching_in_njfl,
            cast(`years_exp_outside_kipp` as int) as years_exp_outside_kipp,
            cast(`years_teaching_outside_njfl` as int) as years_teaching_outside_njfl,
            cast(
                regexp_extract(`respondent_name`, r'(\d{6})') as int
            ) as employee_number,
            replace(`alumni_status`, ',', '.') as alumni_status,
            replace(`path_to_education`, ',', '.') as path_to_education,
            replace(`relay_status`, ',', '.') as relay_status,
            replace(
                `community_grew_up`,
                'Newark, Camden, and/or Miami',
                'the cities we serve'
            ) as community_grew_up,
            replace(
                `community_professional_exp`,
                'Newark, Camden, and/or Miami',
                'the cities we serve'
            ) as community_professional_exp,
        from
            form_responses pivot (
                max(pivot_column_value) for item_abbreviation in (
                    'additional_languages',
                    'alumni_status',
                    'cert_barriers',
                    'cert_out_of_state_details',
                    'cert_required',
                    'cert_status',
                    'cert_steps_taken',
                    'community_grew_up',
                    'community_professional_exp',
                    'fl_additional_cert_1',
                    'fl_cert_endorsement_1',
                    'fl_cert_endorsement_2',
                    'fl_cert_endorsement_3',
                    'fl_cert_endorsement_4',
                    'fl_cert_endorsement_5',
                    'fl_cert_expiration_1',
                    'fl_cert_expiration_2',
                    'fl_cert_expiration_3',
                    'fl_cert_expiration_4',
                    'fl_cert_expiration_5',
                    'fl_open_to_student_teacher',
                    'gender_identity',
                    'languages_spoken',
                    'level_of_education',
                    'nj_cert_additional_1',
                    'nj_cert_document_link_1',
                    'nj_cert_document_link_2',
                    'nj_cert_document_link_3',
                    'nj_cert_document_link_4',
                    'nj_cert_document_link_5',
                    'nj_cert_endorsement_1',
                    'nj_cert_endorsement_2',
                    'nj_cert_endorsement_3',
                    'nj_cert_endorsement_4',
                    'nj_cert_endorsement_5',
                    'nj_cert_issue_date_1',
                    'nj_cert_issue_date_2',
                    'nj_cert_issue_date_3',
                    'nj_cert_issue_date_4',
                    'nj_cert_issue_date_5',
                    'nj_cert_type_1',
                    'nj_cert_type_2',
                    'nj_cert_type_3',
                    'nj_cert_type_4',
                    'nj_cert_type_5',
                    'path_to_education',
                    'race_ethnicity',
                    'relay_status',
                    'respondent_name',
                    'undergraduate_school',
                    'years_exp_outside_kipp',
                    'years_teaching_in_njfl',
                    'years_teaching_outside_njfl'
                )
            )
    ),

    multiselect_options as (
        select
            response_id,
            string_agg(alumni_status) as alumni_status,
            string_agg(community_grew_up) as community_grew_up,
            string_agg(community_professional_exp) as community_professional_exp,
            string_agg(languages_spoken) as languages_spoken,
            string_agg(path_to_education) as path_to_education,
            string_agg(race_ethnicity) as race_ethnicity,
            string_agg(relay_status) as relay_status,
        from response_pivot
        group by response_id
    )

select
    rp.response_id,
    rp.respondent_email,
    rp.last_submitted_time,

    rp.employee_number,
    rp.respondent_name,

    rp.additional_languages,
    rp.cert_barriers,
    rp.cert_out_of_state_details,
    rp.cert_required,
    rp.cert_status,
    rp.cert_steps_taken,
    rp.fl_additional_cert_1,
    rp.fl_cert_endorsement_1,
    rp.fl_cert_endorsement_2,
    rp.fl_cert_endorsement_3,
    rp.fl_cert_endorsement_4,
    rp.fl_cert_endorsement_5,
    rp.fl_cert_expiration_1,
    rp.fl_cert_expiration_2,
    rp.fl_cert_expiration_3,
    rp.fl_cert_expiration_4,
    rp.fl_cert_expiration_5,
    rp.fl_open_to_student_teacher,
    rp.gender_identity,
    rp.level_of_education,
    rp.nj_cert_additional_1,
    rp.nj_cert_document_link_1,
    rp.nj_cert_document_link_2,
    rp.nj_cert_document_link_3,
    rp.nj_cert_document_link_4,
    rp.nj_cert_document_link_5,
    rp.nj_cert_endorsement_1,
    rp.nj_cert_endorsement_2,
    rp.nj_cert_endorsement_3,
    rp.nj_cert_endorsement_4,
    rp.nj_cert_endorsement_5,
    rp.nj_cert_issue_date_1,
    rp.nj_cert_issue_date_2,
    rp.nj_cert_issue_date_3,
    rp.nj_cert_issue_date_4,
    rp.nj_cert_issue_date_5,
    rp.nj_cert_type_1,
    rp.nj_cert_type_2,
    rp.nj_cert_type_3,
    rp.nj_cert_type_4,
    rp.nj_cert_type_5,
    rp.undergraduate_school,
    rp.years_exp_outside_kipp,
    rp.years_teaching_in_njfl,
    rp.years_teaching_outside_njfl,

    mo.alumni_status,
    mo.community_grew_up,
    mo.community_professional_exp,
    mo.languages_spoken,
    mo.path_to_education,
    mo.race_ethnicity,
    mo.relay_status,
from response_pivot as rp
inner join multiselect_options as mo on rp.response_id = mo.response_id

-- union all

-- select
--     null as response_id,
--     respondent_email,
--     cast(timestamp as datetime format 'MM/DD/YYYY HH24:MI:SS') as last_submitted_time,

--     cast(regexp_extract(respondent_name, r'\((\d{6})\)') as int) as employee_number,
--     respondent_name,

--     additional_languages,
--     cast(cert_required as string) as cert_required,
--     cert_barriers,
--     cert_out_of_state_details,
--     cert_status,
--     cert_steps_taken,
--     fl_additional_cert_1,
--     fl_cert_endorsement_1,
--     fl_cert_endorsement_2,
--     fl_cert_endorsement_3,
--     fl_cert_endorsement_4,
--     fl_cert_endorsement_5,
--     fl_cert_expiration_1,
--     fl_cert_expiration_2,
--     fl_cert_expiration_3,
--     fl_cert_expiration_4,
--     fl_cert_expiration_5,
--     fl_open_to_student_teacher,
--     gender_identity,
--     level_of_education,
--     nj_cert_additional_1,
--     nj_cert_document_link_1,
--     nj_cert_document_link_2,
--     nj_cert_document_link_3,
--     nj_cert_document_link_4,
--     nj_cert_document_link_5,
--     nj_cert_endorsement_1,
--     nj_cert_endorsement_2,
--     nj_cert_endorsement_3,
--     nj_cert_endorsement_4,
--     nj_cert_endorsement_5,
--     nj_cert_issue_date_1,
--     nj_cert_issue_date_2,
--     nj_cert_issue_date_3,
--     nj_cert_issue_date_4,
--     nj_cert_issue_date_5,
--     nj_cert_type_1,
--     nj_cert_type_2,
--     nj_cert_type_3,
--     nj_cert_type_4,
--     nj_cert_type_5,
--     undergraduate_school,
--     years_exp_outside_kipp,
--     years_teaching_in_njfl,
--     years_teaching_outside_njfl,

--     {# multiselect_options #}
--     alumni_status,
--     community_grew_up,
--     community_professional_experience as community_professional_exp,
--     languages_spoken,
--     path_to_education,
--     race_ethnicity,
--     relay_status,
-- from `teamster-332318.kipptaf_surveys.src_surveys__staff_info_certification`
